# Efficiency: locality
_COSC 208, Introduction to Computer Systems, 2022-04-01_

## Announcements
* Exam 2
    * Study guide posted on Moodle
    * Take-home portion: released after class on Monday; due Thursday at 11pm 
    * In-class portion: during class on Wednesday

## Outline
* Warm-up: reducing data movement
* Locality
* Optimizing loops for locality

## Warm-up: reducing data movement
* Q1: _Cross-out unecesary loads and stores for each of the following snippets of assembly code_
    ```
    000000000000088c <interest_due>:
        88c:    sub    sp, sp, #0x20
        890:    str    w0, [sp, #12]    XXXXX
        894:    str    w1, [sp, #8]     XXXXX
        898:    ldr    w0, [sp, #12]    XXXXX
        89c:    ldr    w1, [sp, #8]     XXXXX
        8a0:    mul    w0, w1, w0
        8a4:    str    w0, [sp, #20]
        8a8:    mov    w0, #0x4b0
        8ac:    str    w0, [sp, #24]    XXXXX
        8b0:    ldr    w1, [sp, #20]
        8b4:    ldr    w0, [sp, #24]    XXXXX
        8b8:    sdiv   w0, w1, w0
        8bc:    str    w0, [sp, #28]    XXXXX
        8c0:    ldr    w0, [sp, #28]    XXXXX
        8c4:    add    sp, sp, #0x20
        8c8:    ret
    ```
    ```
    0000000000400544 <sum>:
        400544:    d10043ff     sub    sp, sp, #0x10
        400548:    b9000fe0     str    w0, [sp, #12]
        40054c:    b9000be1     str    w1, [sp, #8] 
        400550:    b9400fe8     ldr    w8, [sp, #12]
        400554:    b9400be9     ldr    w9, [sp, #8] 
        400558:    0b090108     add    w8, w8, w9   
        40055c:    b90007e8     str    w8, [sp, #4] 
        400560:    b94007e0     ldr    w0, [sp, #4] 
        400564:    910043ff     add    sp, sp, #0x10
        400568:    d65f03c0     ret                 
    ```
* Update register assignments to eliminate loads and stores
    * Must preserve calling conventions
        * Parameters are stored in w/x0, w/x1, ...
        * Return value is stored in w/x0
        * Caller must store register values into caller's stack frame before `bl` to callee — actually only needed if values in registers are needed by caller after `bl` and callee overwrites the values in those registers
    * Example
    ```
    000000000000088c <interest_due>:
        88c:    sub    sp, sp, #0x20    XXXXX
        8a0:    mul    w0, w1, w0       
        8a4:    str    w0, [sp, #20]    XXXXX
        8a8:    mov    w0, #0x4b0       // mov w1 #0x4b0
        8b0:    ldr    w1, [sp, #20]    XXXXX
        8b8:    sdiv   w0, w1, w0       // sdiv w0, w0, w1
        8c4:    add    sp, sp, #0x20    XXXXX
        8c8:    ret
    ```
    ```
    0000000000400544 <sum>:
        400544:    d10043ff     sub    sp, sp, #0x10    XXXXX
        400548:    b9000fe0     str    w0, [sp, #12]    XXXXX
        40054c:    b9000be1     str    w1, [sp, #8]     XXXXX
        400550:    b9400fe8     ldr    w8, [sp, #12]    XXXXX
        400554:    b9400be9     ldr    w9, [sp, #8]     XXXXX
        400558:    0b090108     add    w8, w8, w9       // add w0, w0, w1
        40055c:    b90007e8     str    w8, [sp, #4]     XXXXX
        400560:    b94007e0     ldr    w0, [sp, #4]     XXXXX
        400564:    910043ff     add    sp, sp, #0x10    XXXXX
        400568:    d65f03c0     ret                 
    ```

## Temporal vs. spatial locality
* _What is temporal locality?_
    * Access the same data repeatedly
    * E.g., for loop variable
* _What is spatial locality?_
    * Access data with a similar scope
    * E.g., next item in array
    * E.g., local variables/parameters, which are stored in the same stack frame
* Analogies for temporal and spatial locality
    * Book storage (Dive Into Systems Section 11.3.2)
        * Temporal locality — store most frequently used books at your desk, less frequently used books on your bookshelf, and least frequently used books at the library
        * Spatial locality — checkout books on the same/nearby subjects when you go to the library
    * Groceries (pre-class questions 3 & 4)
        * Temporal locality — you store food you eat frequently in the front of the refridgerator, while you store food you eat infrequently in the back of the refrigerator
        * Spatial locality — you organize the items on your grocery list based on the aisle in which they are located
    * Breakout groups: _Develop your own analogy for temporal and spatial locality_

## Optimizing loops for locality
* Techniques
    * Loop interchange — with nested loops, swap inner and outer loop
    * Loop fussion — combine two loops at the same level into a single loop
    * Loop fission — split a single loop into two loops at the same level
* Q2: _Modify the following function to improve spatial locality_
    ```C
    int *hundreds() {
        int *nums = malloc(sizeof(int) * 1000);
        for (int i = 0; i < 100; i++) {
            for (int j = 0; j < 1000; j+= 100) {
                nums[i+j] = i;
            }
        }
    }
    ```
    Perform loop interchange
    ```C
    int *hundreds_optimized() {
        int *nums = malloc(sizeof(int) * 1000);
        for (int j = 0; j < 1000; j+= 100) {
            for (int i = 0; i < 100; i++) {
                nums[i+j] = i;
            }
        }
    }
    ```
* Q3: _Modify the following function to improve temporal locality_
    ```C
    int odds(int *nums, int length) {
        for (int i = 0; i < length; i++) {
            nums[i] = nums[i] % 2;
        }
        int count = 0;
        for (int j = 0; j < length; j++) {
            count += nums[j];
        }
        return count;
    }
    ```
    Perform loop fusion
    ```C
    int odds_optimized(int *nums, int length) {
        int count = =0;
        for (int i = 0; i < length; i++) {
            nums[i] = nums[i] % 2;
            count += nums[i];
        }
        return count;
    }
    ```
* Q4: _Modify the following function to improve spatial locality_
    ```C
    void multiplication(int grid[][], int rows, int cols) {
        for (int c = 0; c < cols; c++) {
            for (int r = 0; r < rows; r++) {
                grid[r][c] = c * r;
            }
        }
    }
    ```
    Perform loop interchange
    ```C
    void multiplication_optimized(int grid[][], int rows, int cols) {
        for (int r = 0; r < rows; r++) {
            for (int c = 0; c < cols; c++) {
                grid[r][c] = c * r;
            }
        }
    }
    ```
* Q5: _Modify the following function to improve temporal locality_
    ```C
    long stdev(int *nums, int length) {
        long sum = 0;
        for (int i = 0; i < length; i++) {
            sum += nums[i];
        }
        int mean = sum / length;
        sum = 0;
        for (int j = 0; j < length; j++) {
            int diff = nums[j] - mean;
            sum += diff * diff:
        }
        mean = sum / length;
        return sqrt(mean);
    }
    ```
    It's not possible to optimize this code more—there are no loops to interchange; there are no loops to fission; the loops cannot be fused.