# Multiprocessing: making programs multi-threaded
_COSC 208, Introduction to Computer Systems, 2022-04-27_

## Announcements
* Project 4 due Thursday, May 5

## Outline
* SETs
* Returning values from threads
* Practice writing multi-threaded programs

## SETs

## Returning values from threads
* _When does a thread end?_ — when the function passed to `pthread_create` finishes (i.e., returns)
* _What happens to a function's parameters and local variables when the function returns?_ — they no longer exist (i.e., the stack frame is destroyed)
* _Where should we store a value that should exist even after a function returns?_ — on the heap
* Need to store a thread's return value on the heap
* Thread returns a pointer to the value on the heap
* Example
    ```C
    1   #include <stdio.h>
    2   #include <stdlib.h>
    3   #include <string.h>
    4   #include <pthread.h>
    5   void *length(void *arg) {
    6       char *str = (char *)arg;
    7       int *len = malloc(sizeof(int));
    8       *len = strlen(str);
    9       return len;
    10  }
    11  int main() {
    12      pthread_t thread;
    13      char *phrase = "Hello, threads!";
    14      pthread_create(&thread, NULL, &length, phrase);
    15      int *result = NULL;
    16      pthread_join(thread, (void *)&result);
    17      printf("Length: %d\n", *result);
    18      free(result);
    19  }
    ```
* `pthread_join` returns `0` if successful, or an error number
* To get the pointer returned by the thread, we need to pass a location where the pointer can be stored — i.e., we need to pass a double pointer

## Practice writing multi-threaded programs
* Q1: _Write a function called `sum_array` which takes an array of `ARRAY_LEN` integers and returns the sum of the integers. Your function should have the appropriate prototype/implementation to serve as the entry point for a thread. Assume `ARRAY_LEN` is a constant which has been `#define`d._
    ```C
    #include <pthread.h>
    #include <stdio.h>
    #include <stdlib.h>

    #define ARRAY_LEN 10
    #define NUM_ARRAYS 5

    void *sum_array(void *args) {
        int *nums = (int *)args;
        int *sum = malloc(sizeof(int));
        *sum = 0;
        for (int i = 0; i < ARRAY_LEN; i++) {
            *sum += nums[i];
        }
        return sum;
    }
    ```
* Q2: _Write a function called `sum_matrix` which takes an array of `NUM_ARRAYS` arrays of integers (i.e., an `int **`) and returns the sum of all the integers. The function should create `NUM_ARRAYS` threads, each running the `sum_array` function for a single array of integers. Assume `NUM_ARRAYS` is a constant which has been `#define`d._
    ```C
    int sum_matrix(int *matrix[]) {
        pthread_t threads[NUM_ARRAYS];
        for (int i = 0; i < NUM_ARRAYS; i++) {
            pthread_create(&(threads[i]), NULL, &sum_array, matrix[i]);
        }

        int total = 0;
        for (int i = 0; i < NUM_ARRAYS; i++) {
            int *sum;
            pthread_join(threads[i], (void **)(&sum));
            total += *sum;
            free(sum);
        }
        
        return total;
    }

    int main() {
        int *matrix[NUM_ARRAYS];
        for (int i = 0; i < NUM_ARRAYS; i++) {
            matrix[i] = malloc(sizeof(int) * ARRAY_LEN);
            for (int j = 0; j < ARRAY_LEN; j++) {
                matrix[i][j] = i * 100 + j;
            }
        }

        int sum = sum_matrix(matrix);
        printf("%d\n", sum);
    }
    ```

## Extra practice
* Q5: _What are all possible outputs produced by this program?_
    ```C
    1   #include <pthread.h>
    2   void *printer(void *arg) {
    3       char *ch = (char*)arg;
    4       printf("I am %c\n", *ch);
    5       return NULL;
    6   }
    7   int main() {
    8       pthread_t thread1, thread2;
    9       char *ch = malloc(sizeof(char));
    10      *ch = 'A';
    11      pthread_create(&thread1, NULL, &printer, ch);
    12      *ch = 'B';
    13      pthread_create(&thread2, NULL, &printer, ch);
    14      pthread_join(thread1, NULL);
    15      pthread_join(thread2, NULL);
    16  }
    ```
    ```
    I am A	
    I am B
    ```
    OR
    ```
	I am B
	I am B
    ```